<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">

    <title>Bug probability calculator</title>

    <style>
        .axis path,
        .axis line {
            stroke: black;
            fill: none;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 14px;
        }

        .betaline {
            fill: none;
            stroke-width: 2;
            stroke: rgba(0, 0, 255, 1);
        }

        .credarea {
            fill: blue;
        }

        .controls-container {
            float: left;
            width: 100%;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark">
        <a class="navbar-brand" href="#">Bug probability calculator</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsBugprob" aria-controls="navbarsBugprob" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarsBugprob">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="controls-container">
            <form>
                <div class="form-group row">
                    <label for="k" class="col-sm-2 col-form-label">k:</label>
                    <div class="col-sm-10">
                        <input id="k" type="number" class="form-control" value="1"></input>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="n" class="col-sm-2 col-form-label">n:</label>
                    <div class="col-sm-10">
                        <input id="n" type="number" class="form-control" value="1"></input>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="alpha" class="col-auto col-form-label">alpha:</label>
                    <div class="col-auto">
                        <input id="alpha" type="number" class="form-control" value="2"></input>
                    </div>
                    <label for="beta" class="col-auto col-form-label">beta:</label>
                    <div class="col-auto">
                        <input id="beta" type="number" class="form-control" value="2"></input>
                    </div>
                </div>
            </form>
        </div>

        <div id="vis"></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.16.3/math.js"></script>

    <script type="text/javascript">
        // Conectors: //////////////////////////////////////

        $("#k").change(function() {
            var k = Number($("#k").val());
            var n = Number($("#n").val());
            if (k < 0) {
                k = 0;
            }
            if (n < k) {
                n = k;
            }
            $("#k").val(k);
            $("#n").val(n);
            $("#alpha").val(k + 1);
            $("#beta").val(n - k + 1);
            updateBeta();
        });

        $("#n").change(function() {
            var k = Number($("#k").val());
            var n = Number($("#n").val());
            if (n < 1) {
                n = 1;
            }
            if (n < k) {
                k = n;
            }
            $("#k").val(k);
            $("#n").val(n);
            $("#alpha").val(k + 1);
            $("#beta").val(n - k + 1);
            updateBeta();
        });

        $("#alpha").change(function() {
            updateBeta();
        });

        $("#beta").change(function() {
            updateBeta();
        });

        // Math: ////////////////////////////////////

        function betaPDF(x, alpha, beta) {
            // Function that calculates the beta distribution y from x and parameters
            if (alpha + beta > 120) {
                var bigalpha = math.bignumber(alpha)
                var bigbeta = math.bignumber(beta)
                var betafuncval = math.divide(math.gamma(math.add(bigalpha, bigbeta)),
                    (math.multiply(math.gamma(bigalpha),
                        math.gamma(bigbeta))));
            } else {
                var betafuncval = math.gamma(alpha + beta) /
                    (math.gamma(alpha) * math.gamma(beta));
            }
            return Math.pow(x, alpha - 1) *
                Math.pow(1 - x, beta - 1) *
                betafuncval;
        }

        function calcBeta(alpha, beta) {
            // Calculate x and y, arrays giving points on the Beta PDF.
            var meanX = alpha / (alpha + beta);
            var maxY = 1.1 * betaPDF(meanX, alpha, beta);
            var linexy = [];
            var credxy = []
            var credx = 1;
            var credarea = 0;
            var credfirst = true;
            for (var xi = 0; xi <= 1; xi = xi + 0.001) {
                yi = betaPDF(xi, alpha, beta)
                if (isFinite(yi)) {
                    linexy.push([xi, yi]);
                }
                credarea = credarea + yi * 0.001;
                if (credarea > 0.05) {
                    if (credfirst) {
                        credx = xi;
                        credxy.push([xi, 0]);
                        credfirst = false;
                    }
                    if (isFinite(yi)) {
                        credxy.push([xi, yi]);
                    } else {
                        credxy.push([xi, maxY]);
                    }
                }
            }
            credxy.push([1, 0]);
            return [linexy, credxy];
        }

        // Draw using d3: ///////////////////////////

        function updateBeta() {
            var width = 800,
                height = 400,
                margin = 40;

            var alpha = Number($("#alpha").val());
            var beta = Number($("#beta").val());
            var meanX = alpha / (alpha + beta);
            var maxY = 1.1 * betaPDF(meanX, alpha, beta);

            var xscale = d3.scale.linear()
                .domain([0, 1])
                .range([0 + margin, width - margin]);
            var yscale = d3.scale.linear()
                .domain([maxY, 0])
                .range([0 + margin, height - margin]);

            // Draw the Beta PDF and credible area.
            var lineFunction = d3.svg.line()
                .x(function(d) {
                    return xscale(d[0]);
                })
                .y(function(d) {
                    return yscale(d[1]);
                })
                .interpolate("linear");

            var calcbeta = calcBeta(alpha, beta);
            var linexy = calcbeta[0];
            var credxy = calcbeta[1];
            d3.select("path.betaline")
                .transition()
                .attr("d", lineFunction(linexy));

            // Y-axis.
            var yAxis = d3.svg.axis().scale(yscale).orient("left");
            d3.select("g.yaxis")
                .transition()
                .attr("transform", "translate(" + margin + ",0)")
                .call(yAxis);
        }

        function initBeta() {
            var width = 800,
                height = 400,
                margin = 40;

            // Get the parameters from the sliders.
            var alpha = Number($("#alpha").val());
            var beta = Number($("#beta").val());
            var mean = alpha / (alpha + beta);
            var maxY = 1.1 * betaPDF(mean, alpha, beta);

            // Create the rescaling transformations.
            var xscale = d3.scale.linear()
                .domain([0, 1])
                .range([0 + margin, width - margin]);
            var yscale = d3.scale.linear()
                .domain([maxY, 0])
                .range([0 + margin, height - margin]);

            // Draw the Beta PDF and credible area.
            var lineFunction = d3.svg.line()
                .x(function(d) {
                    return xscale(d[0]);
                })
                .y(function(d) {
                    return yscale(d[1]);
                })
                .interpolate("linear");

            var vis = d3.select("#vis")
                .append("svg:svg")
                .attr("width", width)
                .attr("height", height);
            var g = vis.append("svg:g");

            var calcbeta = calcBeta(alpha, beta, xscale, yscale);
            var linexy = calcbeta[0];
            var credxy = calcbeta[1];

            // X-axis.
            var xAxis = d3.svg.axis().scale(xscale).orient("bottom");
            g.append("g")
                .attr("class", "axis xaxis")
                .attr("transform", "translate(0," + (height - margin) + ")")
                .call(xAxis);

            // Y-axis.
            var yAxis = d3.svg.axis().scale(yscale).orient("left");
            g.append("g")
                .attr("class", "axis yaxis")
                .attr("transform", "translate(" + margin + ",0)")
                .call(yAxis);

            // cred X value
            /* g.append("text")*/
            /* .attr("class", "x label")*/
            /* .attr("text-anchor", "middle")*/
            /* .attr("x", xscale(credx))*/
            /* .attr("y", height - 6)*/
            /* .text(credx.toFixed(3));*/

            g.append("path")
                .attr("class", "betaline")
                .attr("d", lineFunction(linexy));
            /* g.append("path")*/
            /* .attr("class", "credarea")*/
            /* .attr("d", lineFunction(credxy));*/
        }

        initBeta();
    </script>

</body>

</html>
